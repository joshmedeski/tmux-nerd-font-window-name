#!/usr/bin/env bash

NAME="$1"
PANES="$2"
CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_CONFIG="$CURRENT_DIR/defaults.yml"
USER_CONFIG="$HOME/.config/tmux/tmux-nerd-font-window-name.yml"

PLUGINS="yq"
MISSING_PLUGINS_LIST=""

startup_message() {
	for i in $PLUGINS; do
		if [[ ! $(which $i) ]]; then
			MISSING_PLUGINS_LIST="${MISSING_PLUGINS_LIST}\t- ${i}\n";
		fi;
	done
	if [[ $MISSING_PLUGINS_LIST != "" ]]; then
		tmux set-hook -g session-created 'display-popup echo "[33mError:[0m\n\
The following dependencies are required for tmux-nerd-font-window-name to work properly:\n\
'"${MISSING_PLUGINS_LIST}"'\n\
Please ensure all dependencies are installed correctly.\n\
[2;3m(Press [0;33;1mESC[0;2;3m key to dismiss)[0m"'
	else
		tmux set-hook -gu session-created
	fi
}

startup_message

get_config_value() {
	local key=$1
	local value
	if test -f "$USER_CONFIG"; then
		value="$(yq "$key" "$USER_CONFIG")"
		if [ "$value" == "null" ]; then # get default config value
			value="$(yq "$key" "$DEFAULT_CONFIG")"
		fi
	else
		value="$(yq "$key" "$DEFAULT_CONFIG")"
	fi
	echo "$value"
}

ICON="$(get_config_value ".icons.$NAME")"

if [ "$ICON" == "null" ]; then
	FALLBACK_ICON="$(get_config_value '.config.fallback-icon')"
	ICON="$FALLBACK_ICON"
fi

if [ "$PANES" -gt 1 ]; then
	MULTI_PANE_ICON="$(get_config_value '.config.multi-pane-icon')"
	if [ "$MULTI_PANE_ICON" != "null" ]; then
		ICON="$MULTI_PANE_ICON $ICON"
	fi
fi

SHOW_NAME="$(get_config_value '.config.show-name')"
if [ "$SHOW_NAME" = true ]; then
	ICON="$ICON $NAME"
fi

echo "$ICON"
